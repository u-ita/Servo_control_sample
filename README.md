# Servo Control Sample

Arduino用のサーボ制御サンプルコードです。S.BUS通信プロトコルを使用したサーボモーター制御システムを実装しています。

## プロジェクト構成

```
Servo_control_sample/
├── SBUS_test_02_tsubame/    # メインプログラム
│   └── SBUS_test_02_tsubame.ino
└── analog2serial/            # デバッグ/テスト用プログラム
    └── analog2serial.ino
```

## 1. SBUS_test_02_tsubame（メインプログラム）

S.BUS通信プロトコルを使用したサーボモーター制御プログラムです。

### 主要機能

- **ジョイスティック入力**: アナログピン（A0, A1）からジョイスティックの電圧を読み取り
- **トリム機能**: デジタルピン（2-5）に接続されたスイッチで±30度の範囲で微調整可能
- **断線検出**: 異常電圧を検出した場合、自動的に中立位置に固定
- **速度制限**: サーボの急激な動きを防ぐため、1ループあたり3.0度の速度制限を実装
- **S.BUS通信**: 100kbps、8E2（8bit、Even パリティ、2 Stop bit）で通信
- **角度範囲制限**: -90度〜+90度の範囲に制限

### ハードウェア構成

#### 入力ピン
- **A0, A1**: ジョイスティックのアナログ入力
- **D2**: トリムX軸 増加スイッチ（INPUT_PULLUP）
- **D3**: トリムX軸 減少スイッチ（INPUT_PULLUP）
- **D4**: トリムY軸 増加スイッチ（INPUT_PULLUP）
- **D5**: トリムY軸 減少スイッチ（INPUT_PULLUP）

#### 出力
- **Serial**: S.BUS通信（100kbps、8E2）

### 処理フロー

1. ジョイスティック入力読み取り（`analogRead(A0)`, `analogRead(A1)`）
2. トリム値の計算（スイッチ入力に基づく）
3. 断線検出と中立位置への補正
4. アナログ値を角度（-90〜+90度）に変換
5. 速度制限処理の適用
6. 角度をS.BUSフォーマット（0〜2047）に変換
7. S.BUSプロトコルでデータを送信
8. 10ms待機（約100Hz制御周期）

### パラメータ設定

```cpp
#define SBUS_SPEED    100000     // SBUS通信速度
#define SPEED_LIMIT   3.0        // サーボの最大速度制限（度/ループ）
```

### トリム機能

- トリム範囲: ±30度
- 調整ステップ: 0.25度
- スイッチを押し続けることで連続的に調整可能

### 安全機能

#### 断線検出
ジョイスティックの電圧値が異常範囲（40未満または950超）の場合、中立位置（474）に固定します。

#### 速度制限
サーボの急激な動きを防ぐため、1制御サイクルあたりの角度変化を`SPEED_LIMIT`（デフォルト3.0度）に制限します。

## 2. analog2serial（デバッグ/テスト用）

シンプルなアナログ入力テストプログラムです。

### 機能

- アナログピンA0とA1の値を読み取り
- シリアルポート（9600bps）に出力
- ジョイスティックの動作確認やデバッグに使用

### 使用方法

1. プログラムをArduinoにアップロード
2. シリアルモニタを9600bpsで開く
3. ジョイスティックを動かして値を確認

## 使用方法

### 1. ハードウェアの準備

1. Arduinoボードを用意
2. ジョイスティックをA0、A1ピンに接続
3. トリム調整用のスイッチをD2-D5に接続（プルアップ設定）
4. S.BUS対応サーボをSerialピンに接続

### 2. プログラムのアップロード

1. Arduino IDEで`SBUS_test_02_tsubame/SBUS_test_02_tsubame.ino`を開く
2. 適切なボードとポートを選択
3. プログラムをアップロード

### 3. 動作確認

1. ジョイスティックを動かしてサーボが動作することを確認
2. トリムスイッチでオフセット調整が可能
3. 速度制限により滑らかな動作を確認

## 技術詳細

### S.BUSプロトコル

S.BUSは最大16チャンネルのデジタルサーボ制御プロトコルです：

- **通信速度**: 100kbps
- **データ形式**: 8E2（8bit、Even パリティ、2 Stop bit）
- **データパケット**: 25バイト
- **チャンネル解像度**: 11bit（0-2047）
- **制御周期**: 約100Hz（10ms）

### データ変換

アナログ入力値（0-1023）→角度（-90〜+90度）→S.BUS値（0-2047）

```cpp
// アナログ値を角度に変換
target_angle[0] = (temp2 - 83.0) / 845.0 * 180.0 - 90.0 + trim_x;

// 角度をS.BUS値に変換
sbus_servo_id[i] = (int)((target_angle[i] + 90.0) / 180.0 * 2047.0);
```

## 応用例

- ラジコン飛行機/ヘリコプターの制御
- 小型ロボットアームの操作
- カメラジンバルの制御
- 多軸サーボシステムのプロトタイピング

## ライセンス

このサンプルコードは教育・学習目的で提供されています。

## 作成者

竹中版（Arduino用S.BUS通信プログラム）
